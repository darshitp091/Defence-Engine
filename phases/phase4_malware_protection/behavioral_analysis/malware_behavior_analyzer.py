import time
import threading
import psutil
import os
import subprocess
from collections import deque
from typing import Dict, List, Optional, Tuple
import json
import hashlib
import socket
import requests

class MalwareBehaviorAnalyzer:
    def __init__(self):
        self.monitoring_active = False
        self.monitoring_thread = None
        self.process_history = deque(maxlen=10000)
        self.network_connections = deque(maxlen=5000)
        self.file_operations = deque(maxlen=5000)
        self.registry_operations = deque(maxlen=5000)
        
        # Malware behavior patterns
        self.suspicious_behaviors = {
            'process_injection': [
                'CreateRemoteThread', 'WriteProcessMemory', 'VirtualAllocEx',
                'OpenProcess', 'NtCreateThreadEx', 'RtlCreateUserThread'
            ],
            'network_anomalies': [
                'unusual_ports', 'high_frequency_connections', 'suspicious_domains',
                'encrypted_traffic', 'tor_usage', 'proxy_usage'
            ],
            'file_anomalies': [
                'mass_file_creation', 'system_file_modification', 'encryption_activity',
                'deletion_spree', 'hidden_files', 'executable_in_data'
            ],
            'registry_anomalies': [
                'startup_modification', 'service_creation', 'policy_changes',
                'security_settings', 'user_account_creation'
            ],
            'system_anomalies': [
                'high_cpu_usage', 'memory_injection', 'driver_loading',
                'service_creation', 'scheduled_task_creation', 'log_clearing'
            ]
        }
        
        self.malware_indicators = {
            'crypto_ransomware': [
                'file_encryption', 'ransom_note_creation', 'file_extension_changes',
                'massive_file_operations', 'encryption_key_generation'
            ],
            'trojan_horse': [
                'backdoor_creation', 'remote_access_setup', 'credential_harvesting',
                'keylogger_activity', 'screen_capture'
            ],
            'rootkit': [
                'driver_loading', 'system_hook_installation', 'process_hiding',
                'file_hiding', 'network_hiding'
            ],
            'botnet': [
                'command_control_communication', 'distributed_attacks',
                'spam_generation', 'ddos_participation'
            ],
            'spyware': [
                'data_exfiltration', 'keystroke_logging', 'screen_capture',
                'browser_monitoring', 'email_monitoring'
            ]
        }
        
        self.analysis_stats = {
            'processes_monitored': 0,
            'suspicious_behaviors_detected': 0,
            'malware_families_identified': 0,
            'false_positives': 0,
            'analysis_errors': 0
        }
        
        self.threat_levels = {
            'low': 0,
            'medium': 1,
            'high': 2,
            'critical': 3
        }
        
        print("üß† Malware Behavior Analyzer initialized!")
        print(f"   Suspicious behaviors: {sum(len(v) for v in self.suspicious_behaviors.values())}")
        print(f"   Malware indicators: {sum(len(v) for v in self.malware_indicators.values())}")

    def start_monitoring(self):
        """Start behavioral monitoring"""
        if self.monitoring_active:
            return
        self.monitoring_active = True
        self.monitoring_thread = threading.Thread(target=self._monitoring_loop, daemon=True)
        self.monitoring_thread.start()
        print("üß† Malware behavior monitoring started!")

    def stop_monitoring(self):
        """Stop behavioral monitoring"""
        self.monitoring_active = False
        if self.monitoring_thread:
            self.monitoring_thread.join(timeout=5)
        print("‚èπÔ∏è Malware behavior monitoring stopped!")

    def _monitoring_loop(self):
        """Main monitoring loop"""
        while self.monitoring_active:
            try:
                self._monitor_processes()
                self._monitor_network_connections()
                self._monitor_file_operations()
                self._monitor_registry_operations()
                self._analyze_behavior_patterns()
                time.sleep(5)  # Monitor every 5 seconds
            except Exception as e:
                print(f"‚ùå Behavior monitoring error: {e}")
                self.analysis_stats['analysis_errors'] += 1
                time.sleep(5)

    def _monitor_processes(self):
        """Monitor running processes for suspicious behavior"""
        try:
            current_time = time.time()
            for proc in psutil.process_iter(['pid', 'name', 'cpu_percent', 'memory_percent', 'create_time', 'cmdline']):
                try:
                    proc_info = proc.info
                    if proc_info['pid'] == 0:  # Skip system processes
                        continue
                    
                    process_data = {
                        'timestamp': current_time,
                        'pid': proc_info['pid'],
                        'name': proc_info['name'],
                        'cpu_percent': proc_info['cpu_percent'],
                        'memory_percent': proc_info['memory_percent'],
                        'create_time': proc_info['create_time'],
                        'cmdline': proc_info['cmdline']
                    }
                    
                    self.process_history.append(process_data)
                    self.analysis_stats['processes_monitored'] += 1
                    
                    # Check for suspicious process behavior
                    self._check_process_anomalies(process_data)
                    
                except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
                    continue
        except Exception as e:
            print(f"‚ùå Process monitoring error: {e}")

    def _monitor_network_connections(self):
        """Monitor network connections for suspicious activity"""
        try:
            current_time = time.time()
            for conn in psutil.net_connections(kind='inet'):
                try:
                    conn_data = {
                        'timestamp': current_time,
                        'fd': conn.fd,
                        'family': conn.family,
                        'type': conn.type,
                        'laddr': conn.laddr,
                        'raddr': conn.raddr,
                        'status': conn.status,
                        'pid': conn.pid
                    }
                    
                    self.network_connections.append(conn_data)
                    
                    # Check for suspicious network behavior
                    self._check_network_anomalies(conn_data)
                    
                except Exception:
                    continue
        except Exception as e:
            print(f"‚ùå Network monitoring error: {e}")

    def _monitor_file_operations(self):
        """Monitor file operations for suspicious activity"""
        try:
            # This is a simplified implementation
            # In a real scenario, you'd use file system monitoring APIs
            current_time = time.time()
            
            # Monitor recent file changes in common directories
            monitor_dirs = [
                os.path.expanduser("~\\Downloads"),
                os.path.expanduser("~\\Desktop"),
                "C:\\Windows\\Temp",
                "C:\\Temp"
            ]
            
            for directory in monitor_dirs:
                if os.path.exists(directory):
                    try:
                        for root, dirs, files in os.walk(directory):
                            for file in files:
                                file_path = os.path.join(root, file)
                                try:
                                    stat = os.stat(file_path)
                                    if current_time - stat.st_mtime < 60:  # Modified in last minute
                                        file_data = {
                                            'timestamp': current_time,
                                            'file_path': file_path,
                                            'size': stat.st_size,
                                            'modified': stat.st_mtime,
                                            'accessed': stat.st_atime
                                        }
                                        self.file_operations.append(file_data)
                                        self._check_file_anomalies(file_data)
                                except Exception:
                                    continue
                    except Exception:
                        continue
        except Exception as e:
            print(f"‚ùå File monitoring error: {e}")

    def _monitor_registry_operations(self):
        """Monitor registry operations for suspicious activity"""
        try:
            # This is a simplified implementation
            # In a real scenario, you'd use registry monitoring APIs
            current_time = time.time()
            
            # Monitor common registry keys for changes
            registry_keys = [
                "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run",
                "HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run",
                "HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services"
            ]
            
            for key in registry_keys:
                try:
                    # This would require Windows-specific registry monitoring
                    # For now, we'll simulate registry monitoring
                    registry_data = {
                        'timestamp': current_time,
                        'key': key,
                        'operation': 'monitored'
                    }
                    self.registry_operations.append(registry_data)
                except Exception:
                    continue
        except Exception as e:
            print(f"‚ùå Registry monitoring error: {e}")

    def _check_process_anomalies(self, process_data: Dict):
        """Check for process anomalies"""
        try:
            # High CPU usage
            if process_data['cpu_percent'] > 80:
                self._report_suspicious_behavior('high_cpu_usage', process_data)
            
            # High memory usage
            if process_data['memory_percent'] > 50:
                self._report_suspicious_behavior('high_memory_usage', process_data)
            
            # Suspicious process names
            suspicious_names = ['malware', 'virus', 'trojan', 'backdoor', 'keylogger', 'spyware']
            process_name = process_data['name'].lower()
            for name in suspicious_names:
                if name in process_name:
                    self._report_suspicious_behavior('suspicious_process_name', process_data)
                    break
            
            # Suspicious command line arguments
            if process_data['cmdline']:
                cmdline = ' '.join(process_data['cmdline']).lower()
                suspicious_cmds = ['powershell -enc', 'cmd /c', 'wscript', 'cscript', 'rundll32']
                for cmd in suspicious_cmds:
                    if cmd in cmdline:
                        self._report_suspicious_behavior('suspicious_command_line', process_data)
                        break
                        
        except Exception as e:
            print(f"‚ùå Process anomaly check error: {e}")

    def _check_network_anomalies(self, conn_data: Dict):
        """Check for network anomalies"""
        try:
            # Unusual ports
            if conn_data['laddr'] and conn_data['laddr'].port > 49152:
                self._report_suspicious_behavior('unusual_ports', conn_data)
            
            # Suspicious remote addresses
            if conn_data['raddr']:
                remote_ip = conn_data['raddr'].ip
                if self._is_suspicious_ip(remote_ip):
                    self._report_suspicious_behavior('suspicious_remote_ip', conn_data)
            
            # High frequency connections
            recent_connections = [c for c in self.network_connections 
                                if time.time() - c['timestamp'] < 60]
            if len(recent_connections) > 100:
                self._report_suspicious_behavior('high_frequency_connections', conn_data)
                
        except Exception as e:
            print(f"‚ùå Network anomaly check error: {e}")

    def _check_file_anomalies(self, file_data: Dict):
        """Check for file anomalies"""
        try:
            # Mass file creation
            recent_files = [f for f in self.file_operations 
                          if time.time() - f['timestamp'] < 60]
            if len(recent_files) > 50:
                self._report_suspicious_behavior('mass_file_creation', file_data)
            
            # Suspicious file extensions
            file_path = file_data['file_path'].lower()
            suspicious_extensions = ['.exe', '.dll', '.bat', '.cmd', '.ps1', '.vbs']
            for ext in suspicious_extensions:
                if file_path.endswith(ext):
                    self._report_suspicious_behavior('suspicious_file_extension', file_data)
                    break
            
            # Large file size
            if file_data['size'] > 100 * 1024 * 1024:  # 100MB
                self._report_suspicious_behavior('large_file_size', file_data)
                
        except Exception as e:
            print(f"‚ùå File anomaly check error: {e}")

    def _is_suspicious_ip(self, ip: str) -> bool:
        """Check if IP address is suspicious"""
        try:
            # Check against known malicious IP ranges
            suspicious_ranges = [
                '10.0.0.0/8',  # Private network (might be suspicious in some contexts)
                '192.168.0.0/16',  # Private network
                '172.16.0.0/12'  # Private network
            ]
            
            # In a real implementation, you'd check against threat intelligence feeds
            # For now, we'll use a simple heuristic
            return False  # Simplified for demo
        except Exception:
            return False

    def _report_suspicious_behavior(self, behavior_type: str, data: Dict):
        """Report suspicious behavior"""
        try:
            self.analysis_stats['suspicious_behaviors_detected'] += 1
            
            behavior_report = {
                'timestamp': time.time(),
                'behavior_type': behavior_type,
                'data': data,
                'threat_level': self._calculate_threat_level(behavior_type),
                'malware_family': self._identify_malware_family(behavior_type)
            }
            
            print(f"üö® SUSPICIOUS BEHAVIOR DETECTED: {behavior_type}")
            print(f"   Threat Level: {behavior_report['threat_level']}")
            print(f"   Malware Family: {behavior_report['malware_family']}")
            
        except Exception as e:
            print(f"‚ùå Error reporting suspicious behavior: {e}")

    def _calculate_threat_level(self, behavior_type: str) -> str:
        """Calculate threat level based on behavior type"""
        if behavior_type in ['high_cpu_usage', 'high_memory_usage']:
            return 'medium'
        elif behavior_type in ['suspicious_process_name', 'suspicious_command_line']:
            return 'high'
        elif behavior_type in ['mass_file_creation', 'suspicious_file_extension']:
            return 'high'
        else:
            return 'low'

    def _identify_malware_family(self, behavior_type: str) -> str:
        """Identify potential malware family based on behavior"""
        if behavior_type in ['mass_file_creation', 'large_file_size']:
            return 'crypto_ransomware'
        elif behavior_type in ['suspicious_command_line', 'suspicious_process_name']:
            return 'trojan_horse'
        elif behavior_type in ['high_cpu_usage', 'high_memory_usage']:
            return 'botnet'
        else:
            return 'unknown'

    def _analyze_behavior_patterns(self):
        """Analyze behavior patterns for malware identification"""
        try:
            # Analyze recent behavior patterns
            recent_behaviors = [b for b in self.process_history 
                              if time.time() - b['timestamp'] < 300]  # Last 5 minutes
            
            if len(recent_behaviors) > 100:
                self._report_suspicious_behavior('high_process_activity', {'count': len(recent_behaviors)})
            
            # Analyze network patterns
            recent_connections = [c for c in self.network_connections 
                                if time.time() - c['timestamp'] < 300]
            
            if len(recent_connections) > 50:
                self._report_suspicious_behavior('high_network_activity', {'count': len(recent_connections)})
                
        except Exception as e:
            print(f"‚ùå Behavior pattern analysis error: {e}")

    def analyze_process_behavior(self, pid: int) -> Dict:
        """Analyze behavior of a specific process"""
        try:
            proc = psutil.Process(pid)
            proc_info = {
                'pid': pid,
                'name': proc.name(),
                'cpu_percent': proc.cpu_percent(),
                'memory_percent': proc.memory_percent(),
                'create_time': proc.create_time(),
                'cmdline': proc.cmdline(),
                'connections': len(proc.connections()),
                'threads': proc.num_threads(),
                'open_files': len(proc.open_files())
            }
            
            # Analyze behavior
            behavior_score = 0
            suspicious_indicators = []
            
            if proc_info['cpu_percent'] > 80:
                behavior_score += 30
                suspicious_indicators.append('high_cpu_usage')
            
            if proc_info['memory_percent'] > 50:
                behavior_score += 25
                suspicious_indicators.append('high_memory_usage')
            
            if proc_info['connections'] > 20:
                behavior_score += 20
                suspicious_indicators.append('high_network_activity')
            
            if proc_info['threads'] > 50:
                behavior_score += 15
                suspicious_indicators.append('high_thread_count')
            
            if proc_info['open_files'] > 100:
                behavior_score += 10
                suspicious_indicators.append('high_file_activity')
            
            threat_level = 'low'
            if behavior_score > 80:
                threat_level = 'critical'
            elif behavior_score > 60:
                threat_level = 'high'
            elif behavior_score > 40:
                threat_level = 'medium'
            
            return {
                'process_info': proc_info,
                'behavior_score': behavior_score,
                'threat_level': threat_level,
                'suspicious_indicators': suspicious_indicators,
                'malware_family': self._identify_malware_family_from_indicators(suspicious_indicators)
            }
            
        except Exception as e:
            return {'error': f'Analysis failed: {e}'}

    def _identify_malware_family_from_indicators(self, indicators: List[str]) -> str:
        """Identify malware family from behavior indicators"""
        if 'high_cpu_usage' in indicators and 'high_memory_usage' in indicators:
            return 'crypto_ransomware'
        elif 'high_network_activity' in indicators:
            return 'botnet'
        elif 'high_file_activity' in indicators:
            return 'spyware'
        else:
            return 'unknown'

    def get_analysis_statistics(self) -> Dict:
        """Get behavioral analysis statistics"""
        return {
            'monitoring_active': self.monitoring_active,
            'processes_monitored': self.analysis_stats['processes_monitored'],
            'suspicious_behaviors_detected': self.analysis_stats['suspicious_behaviors_detected'],
            'malware_families_identified': self.analysis_stats['malware_families_identified'],
            'false_positives': self.analysis_stats['false_positives'],
            'analysis_errors': self.analysis_stats['analysis_errors'],
            'process_history_size': len(self.process_history),
            'network_connections_size': len(self.network_connections),
            'file_operations_size': len(self.file_operations),
            'registry_operations_size': len(self.registry_operations)
        }

    def get_recent_behaviors(self, count: int = 10) -> List[Dict]:
        """Get recent suspicious behaviors"""
        # This would return recent behavior reports
        # For now, return empty list as we don't store them separately
        return []

    def add_custom_behavior_pattern(self, pattern_name: str, pattern_indicators: List[str]):
        """Add custom behavior pattern for detection"""
        self.suspicious_behaviors[pattern_name] = pattern_indicators
        print(f"‚úÖ Added custom behavior pattern: {pattern_name}")

    def update_malware_indicators(self, family: str, indicators: List[str]):
        """Update malware family indicators"""
        self.malware_indicators[family] = indicators
        print(f"‚úÖ Updated malware indicators for {family}")
